{% extends "home/base.html" %}
{% block title %}Home{% endblock %}
{% block content %}
{% load static %}

<style>
  .error-text {
    font-family: Verdana, Geneva, Tahoma, sans-serif;
  }

  html,
  body {
    zoom: 0.9 !important;
  }

  .submit-Btn {
    border-radius: 10px !important;
    background: #0f7abb !important;
    border-color: #0f7abb !important;
    background-color: #0f7abb;
    padding: 45px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 20px;
    border: 1px solid #0f7abb;
    border-radius: 7px;
    color: #fff;
    font-size: 25px !important;
    font-family: inherit !important;
    font-weight: 500;
    width: 250px;
    font-weight: bold !important;
  }

  .clear-Btn {
    width: 50% !important;
    border-radius: 10px !important;
    background: #0f7abb !important;
    border-color: #0f7abb !important;
    border-radius: 10px !important;
    background: #0f7abb !important;
    border-color: #0f7abb !important;
    background-color: #0f7abb;
    padding: 45px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 20px;
    border: 1px solid #0f7abb;
    border-radius: 7px;
    color: #fff;
    font-size: 25px !important;
    font-family: inherit !important;
    font-weight: 500;
    width: 250px;
    font-weight: bold !important;
  }


  #blockContent {
    padding-top: 0px !important;
  }


  /* for multiple images uploader */

  .form-row {
    margin-top: 60px;
  }

  .upload__box {}

  .upload__inputfile {
    width: .1px;
    height: .1px;
    opacity: 0;
    overflow: hidden;
    position: absolute;
    z-index: -1;
  }

  .invalid {
    border: 2px solid #ff0000 !important;
  }

  .upload__btn {
    display: inline-block;
    font-weight: bold;
    color: #fff;
    text-align: center;
    min-width: 116px;
    padding: 15px 25px;
    transition: all .3s ease;
    cursor: pointer;
    border: 2px solid;
    background-color: #6c757d;
    border-color: #4045ba;
    border-radius: 10px;
    line-height: 26px;
    font-size: 81px !important;
  }

  .upload__btn:hover {
    background-color: unset;
    color: #4045ba;
    transition: all .3s ease;
  }

  .upload__btn-box {
    margin-bottom: 10px;
  }

  .upload__img-wrap {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px;
  }

  .upload__img-box {
    width: 200px;
    padding: 0 10px;
    margin-bottom: 12px;
    margin: 10px;
  }

  .upload__img-close {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.5);
    position: absolute;
    top: 10px;
    right: 10px;
    text-align: center;
    line-height: 24px;
    z-index: 1;
    cursor: pointer;
    color: white;
    font-weight: bold;
  }

  .img-bg {
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
    position: relative;
    padding-bottom: 100%;
  }


  /* for signature box */
  /* .flex-row {
    display: flex;
} */
  .wrapper {
    border-right: 0;
  }

  canvas#signature-pad {
    width: 360px;
    height: 100%;
    cursor: hand;
  }

  @media screen and (max-width:616px) {
    canvas#signature-pad {
      /* width: 360px !important; */
      height: 100%;
      cursor: hand;
    }

    .clear-Btn {
      width: 100% !important;
      border-radius: 19px !important;

    }


  }


  .form-control {
    height: auto !important;
  }


  /*  custom styling for boxes */
  input[type="text"],
  input[type="time"],
  input[type="date"],
  textarea,
  canvas,
  input[type="datetime-local"] {
    background: #f6f6f6 !important;
    border-radius: 10px !important;
    color: black !important;
    font-family: Verdana !important;
    padding: 15px 15px;
    border: solid 1px #dcdcdc;
    border-radius: 8px;
    padding: 12px 15px;
  }


  label {
    /* padding-left: 10px !important; */
    font-size: 20px;
    font-weight: bold;
    color: black;
    font-family: 'Roboto', sans-serif;
    margin-bottom: 4px;
  }

  /*  */
  @media screen and (min-width:1180px) {
    #UserForm {
      padding: 0px 250px !important;
    }

    input[type="text"],
    input[type="time"],
    input[type="date"],
    canvas,
    input[type="datetime-local"] {
      width: 90% !important;
    }
  }

  @media screen and (min-width:900px) {
    #UserForm {
      padding: 0px 200px !important;
    }

    input[type="text"],
    input[type="time"],
    input[type="date"],
    textarea,
    canvas,
    input[type="datetime-local"] {
      font-size: 18px;
    }
  }

  @media screen and (max-width:900px) {
    #UserForm {
      padding: 0px 180px !important;
    }

    input[type="text"],
    input[type="time"],
    input[type="date"],
    textarea,
    canvas,
    input[type="datetime-local"] {
      font-size: 1.8vw;
    }
  }

  @media screen and (max-width:768px) {
    #UserForm {
      padding: 0px 100px !important;
    }

    input[type="text"],
    input[type="time"],
    input[type="date"],
    textarea,
    canvas,
    input[type="datetime-local"] {
      font-size: inherit !important;
    }

  }

  @media screen and (max-width:500px) {
    #UserForm {
      padding: 0px 20px !important;
    }

    input[type="text"],
    input[type="time"],
    input[type="date"],
    textarea,
    canvas,
    input[type="datetime-local"] {
      font-size: inherit !important;
    }
  }

  @media screen and (min-width:700px) and (max-width:835px) {
    .clear-Btn {
      width: 100% !important;
    }
</style>

{% if messages %}
<div class="alert col-6 mx-auto" style="background-color: #198754;border-radius: 20px;" role="alert">
  {%for message in messages %}

  <p class="text-white text-center" style="font-size: 30px;color:white;margin-top: 5px;">
    {{ message }}
  </p>
  {% endfor %}
</div>
{% endif %}

<div class="custom-alert d-none" role="alert">

  <div class="d-flex justify-content-center">
    <div class="col-4" style="background-color: #dee2e6;border-radius: 10px;padding: 10px;">
      <h3 class="text-center fw-bold error-text">INVALID</h3>
      <h3 class="text-center fw-bold error-text" style="color: red;">DATE/TIME</h3>
      <h3 class="text-center fw-bold error-text">PLEASE TRY AGAIN</h3>
    </div>
  </div>
</div>

<form class="mainForm" id="UserForm" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <!-- ? Row - 1 -->
  <div class="row mt-5 justify-content-between">
    <div class="col-md-4">
      <div class="form-group">
        <label for="">Date:</label>
        <input required type="date" name="date" class="form-control form-control-lg" />
      </div>
    </div>

    <div class="col-md-4">
      <div class="form-group">
        <label for="">WO/ID:</label>
        <input required type="text" name="ID" class="form-control form-control-lg" placeholder="WO/ID" />
      </div>
    </div>
  </div>


  <!-- ? Row - 2 -->
  <div class="row form-row justify-content-between">
    <div class="col-md-4">
      <div class="form-group">
        <label for="">Customer:</label>
        <input required type="text" name="customer" class="form-control form-control-lg"
          placeholder="Name, Location, Site #" />
      </div>
    </div>


    <div class="col-md-4">
      <div class="form-group">
        <label for="">Job:</label>
        <input required type="text" name="job" class="form-control form-control-lg" placeholder="Job" />
      </div>
    </div>

    <div class="col-md-4">
      <div class="form-group">
        <label for="">Contractor/Tech:</label>
        <input required type="text" name="contractor" class="form-control form-control-lg"
          placeholder="Contractor/Tech:" />
      </div>
    </div>
  </div>


  <!-- ? Row - 3 -->
  <div class="row form-row justify-content-between">
    <div class="col-md-4">
      <div class="form-group">
        <label for="">Clock In:</label>
        <input required type="datetime-local" name="timeIn" class="form-control form-control-lg" placeholder="" />
      </div>
    </div>


    <div class="col-md-4">
      <div class="form-group">
        <label for="">Clock Out:</label>
        <input required type="datetime-local" name="timeOut" class="form-control form-control-lg" placeholder=""
          onchange="calculateTimeDifference()" />
      </div>
    </div>

    <div class="col-md-4">
      <div class="form-group">
        <label for="">Total Hours On-Site:</label>
        <input required type="text" name="totalTime" class="form-control form-control-lg" placeholder="" readonly />
      </div>
    </div>
  </div>


  <!-- ? Row - 4 -->
  <div class="row form-row justify-content-between">

    <div class="col-12">
      <div class="form-group">
        <label for="">Job Description:</label>
        <textarea style="height: 180px !important;" required name="jobDescription" class="form-control form-control-lg"
          id="jobDescription" cols="30" rows="10" placeholder="Enter Your Job Description Here..."></textarea>
        <div class="d-flex justify-content-end py-3">
          <span class="text-end">From 1 To 10,000 Characters</span>
        </div>
      </div>
    </div>

  </div>

  <!-- ? Row - 5 -->
  <div class="upload__box">
    <div class="upload__btn-box">
      <label class="upload__btn ">
        <i class="fa-solid fa-cloud-arrow-up"></i><br><br>
        <p style="font-size: 20px;">UPLOAD IMAGE</p>
        <input required type="file" multiple="" data-max_length="20" class="upload__inputfile" name="uploaded_images">
      </label>
    </div>
    <div class="upload__img-wrap"></div>
  </div>


  <!-- ? Row - 6 -->
  <div class="row form-row justify-content-between">
    <div class="col-12">
      <div class="form-group">
        <label for="">What Was Completed:</label>
        <textarea style="height: 180px !important;" required name="whatWasCompleted"
          class="form-control form-control-lg" id="whatWasCompleted" cols="30" rows="10"
          placeholder="What Was Completed"></textarea>
        <div class="d-flex justify-content-end py-3">
          <span class="text-end">From 1 To 10,000 Characters</span>
        </div>
      </div>
    </div>
  </div>


  <!-- ? Row - 7 -->
  <div class="row form-row justify-content-between">
    <div class="col-12">
      <div class="form-group">
        <label for="">Still Needs Completed:</label>
        <textarea style="height: 180px !important;" required name="stillNeedsCompleted"
          class="form-control form-control-lg" id="stillNeedsCompleted" cols="30" rows="10"
          placeholder="Still Needs Completed"></textarea>
        <div class="d-flex justify-content-end py-3">
          <span class="text-end">From 1 To 10,000 Characters</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ? Row - 8 -->
  <div class="row form-row justify-content-between">
    <div class="col-12">
      <div class="form-group">
        <label for="">Issues/Notes On Site:</label>
        <textarea style="height: 180px !important;" required name="notes" class="form-control form-control-lg"
          id="notes" cols="30" rows="10" placeholder="Issues/Notes On Site"></textarea>
        <div class="d-flex justify-content-end py-3">
          <span class="text-end">From 1 To 10,000 Characters</span>
        </div>
      </div>
    </div>
  </div>


  <!-- ? Row - 9 -->


  <div class="row">
    <div class="col-12 col-sm-6">
      <label for="">Contractor/Tech Signature:</label>
      <div>
        <div class="wrapper">
          <canvas id="signature-pad" width="400" height="200" name="signature"></canvas>
          <img id="signature-img" style="display: none;" alt="Signature">
          <div class="container d-flex justify-content-start w-100">
            <button type="button" id="clear"
              class="clear-Btn btn btn-primary btn-lg btn-get-started fs-2 p-3 mt-4">RESET</button>
          </div>
        </div>
        <!-- <div class="d-flex justify-content-center w-100">

        </div> -->
      </div>

    </div>
  </div>


  <div class="d-flex d-none loadingContainer">
    <div class="col-6 mx-auto">
      <div class="d-flex mx-auto spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <br>
      <p class="text-danger text-center fw-bold">Please dont close your browser untill form is submitted</p>
    </div>

  </div>

  <!-- ? Final Row Submit Button -->
  <div class="row mt-5 py-4">
    <div class="col-md-4 mx-auto d-flex justify-content-center">
      <input id="submitBtn" required type="submit" class="submit-Btn btn btn-primary btn-lg btn-get-started fs-1 p-3"
        value="Submit">
    </div>
  </div>


</form>





<br><br>


{% endblock %}

{% block Script %}

<script>
  window.addEventListener('load', function () {

    var viewportWidth = window.innerWidth || document.documentElement.clientWidth;

    // Check if viewport width is less than 616px (considered as mobile)
    if (viewportWidth < 616) {
      var textareaWidth = document.querySelector('textarea').clientWidth;
      console.log(textareaWidth);
      var signaturePad = document.getElementById('signature-pad');
      signaturePad.style.setProperty('width', `${textareaWidth}px`, 'important');
    }
  });
</script>


<script>


  function formatTime(hoursDiff) {
    // Ensure the time difference is positive
    const absHoursDiff = Math.abs(hoursDiff);

    // Extract the whole hours and minutes
    const hours = Math.floor(absHoursDiff);
    const minutes = Math.round((absHoursDiff % 1) * 60);

    // Format the result as "h:mm"
    const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')}`;

    return formattedTime;
  }

  function calculateTimeDifference() {
    const alertBox = document.querySelector(".custom-alert")
    alertBox.classList.add("d-none")
    const dateTimeIn = document.querySelector("input[name=timeIn]").value;
    const dateTimeOut = document.querySelector("input[name=timeOut]").value;

    // Convert datetime strings to Date objects
    const dateInObject = new Date(dateTimeIn);
    const dateOutObject = new Date(dateTimeOut);

    // Calculate the time difference in milliseconds
    const timeDiff = dateOutObject - dateInObject;

    // Determine if the time difference is positive or negative
    const isPositive = timeDiff >= 0;

    // Convert milliseconds to hours
    const hoursDiff = isPositive ? timeDiff / (1000 * 60 * 60) : -timeDiff / (1000 * 60 * 60);

    // Format the hours difference
    const formattedTimeDiff = formatTime(hoursDiff);

    // Show alert if the value goes negative
    if (!isPositive) {
      // alert("Time difference cannot be negative.");
      alertBox.classList.remove("d-none")

    }
    // Update the time difference input field
    document.querySelector("input[name=totalTime]").value = formattedTimeDiff;
  }



</script>




<!-- script for multiple images uploading -->
<script>


  $(document).ready(function () {
    ImgUpload();
  });

  function ImgUpload() {
    var imgWrap = "";
    var imgArray = [];

    $('.upload__inputfile').each(function () {
      $(this).on('change', function (e) {
        imgWrap = $(this).closest('.upload__box').find('.upload__img-wrap');
        var maxLength = $(this).attr('data-max_length');

        var files = e.target.files;
        var filesArr = Array.prototype.slice.call(files);
        var iterator = 0;
        filesArr.forEach(function (f, index) {

          if (!f.type.match('image.*')) {
            return;
          }

          if (imgArray.length > maxLength) {
            return false
          } else {
            var len = 0;
            for (var i = 0; i < imgArray.length; i++) {
              if (imgArray[i] !== undefined) {
                len++;
              }
            }
            if (len > maxLength) {
              return false;
            } else {
              imgArray.push(f);

              var reader = new FileReader();
              reader.onload = function (e) {
                var html = "<div class='upload__img-box'><div style='background-image: url(" + e.target.result + ")' data-number='" + $(".upload__img-close").length + "' data-file='" + f.name + "' class='img-bg'><div class='upload__img-close'>x</div></div></div>";
                imgWrap.append(html);
                iterator++;
              }
              reader.readAsDataURL(f);
            }
          }
        });
      });
    });

    $('body').on('click', ".upload__img-close", function (e) {
      var file = $(this).parent().data("file");
      for (var i = 0; i < imgArray.length; i++) {
        if (imgArray[i].name === file) {
          imgArray.splice(i, 1);
          break;
        }
      }
      $(this).parent().parent().remove();
    });
  }
</script>




<script>

  document.addEventListener("DOMContentLoaded", function () {
    const user = "{{request.user}}"
    if (user == "AnonymousUser") {
      var inputElements = document.querySelectorAll('input');
      var textareaElements = document.querySelectorAll('textarea');
      function handleInputClick() {
        window.location.href = '/login';
      }
      textareaElements.forEach(function (input) {
        input.addEventListener('click', handleInputClick);
      });
      inputElements.forEach(function (input) {
        input.addEventListener('click', handleInputClick);
      });
    }



    /* var canvas = document.getElementById("signature-pad");
    var clearButton = document.getElementById("clear");
    var form = document.getElementById("UserForm");
    var signatureInput = document.createElement("input");
    signatureInput.type = "hidden";
    signatureInput.name = "signature_data";  // Use this name in your Django view
    form.appendChild(signatureInput);

    var signaturePad = new SignaturePad(canvas, {
      backgroundColor: 'rgb(250,250,250)'
    });

    clearButton.addEventListener('click', function () {
      signaturePad.clear();
    }); */

    var canvas = document.getElementById("signature-pad");
    var clearButton = document.getElementById("clear");
    var signaturePad = new SignaturePad(canvas, {
      backgroundColor: 'rgb(250,250,250)'
    });

    clearButton.addEventListener('click', function () {
      signaturePad.clear();
    });

    // Prevent scrolling on touch devices
    document.body.addEventListener("touchstart", function (e) {
      if (e.target === canvas) {
        e.preventDefault();
      }
    }, { passive: false });

    // Handle touch events for drawing
    canvas.addEventListener("touchstart", onTouchStart, { passive: false });
    canvas.addEventListener("touchmove", onTouchMove, { passive: false });

    function onTouchStart(e) {
      var touch = e.touches[0];
      var mouseEvent = new MouseEvent("mousedown", {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }

    function onTouchMove(e) {
      var touch = e.touches[0];
      var mouseEvent = new MouseEvent("mousemove", {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }


    form.addEventListener("submit", function () {
      $(".loadingContainer").removeClass("d-none");
      var signatureData = signaturePad.toDataURL();
      signatureInput.value = signatureData;
      // go to top
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0;

      setTimeout(function () {
        location.reload();
      }, 5000);

    });


    var submitBtn = document.getElementById("submitBtn");
    submitBtn.addEventListener("click", function () {
      var formControls = document.querySelectorAll('.form-control');
      console.log(formControls)
      formControls.forEach(function (control) {
        if (!control.checkValidity()) {
          control.style.backgroundColor = "#ff0000!important;";
          control.classList.add("invalid");
        }
      });

    });



    $('.form-control').on('input', function () {
      if (!this.checkValidity()) {
        $(this).addClass('invalid');
      } else {
        $(this).removeClass('invalid');
      }
    });




  });
</script>



{% endblock %}




<!--  -->